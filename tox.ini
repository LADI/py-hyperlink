[tox]

envlist =
    test-py{26,27,34,35,36,37,py,py3}
    coverage_report
    packaging

skip_missing_interpreters = {tty:True:False}


##
# Build (default environment)
##

[testenv]

description = run tests

basepython =
    py26: python2.6
    py27: python2.7
    py34: python3.4
    py35: python3.5
    py36: python3.6
    py37: python3.7
    py38: python3.8
    pypy: pypy
    pypy3: pypy3

deps =
    test: coverage==4.5.4
    test: idna==2.8
    test: {py26,py27,py34}: pytest==4.6.6
    test: {py35,py36,py37,py38}: pytest==5.2.1
    test: pytest-cov==2.8.1

passenv =
    # See https://github.com/codecov/codecov-python/blob/master/README.md#using-tox
    # And CI-specific docs:
    #   https://help.github.com/en/articles/virtual-environments-for-github-actions#default-environment-variables
    #   https://docs.travis-ci.com/user/environment-variables#default-environment-variables
    #   https://www.appveyor.com/docs/environment-variables/
    codecov: TOXENV CODECOV_* CI
    codecov: GITHUB_*
    codecov: TRAVIS TRAVIS_*
    codecov: APPVEYOR APPVEYOR_*

    # Used in our AppVeyor config
    codecov: OS

setenv =
    PY_MODULE=hyperlink

    test: COVERAGE_FILE={toxworkdir}/coverage.{envname}
    {coverage_report,codecov}: COVERAGE_FILE={toxworkdir}/coverage
    codecov: COVERAGE_XML={envlogdir}/coverage_report.xml

commands =
    test: pytest --cov={env:PY_MODULE} --cov-report=term-missing:skip-covered --doctest-modules {posargs:src/{env:PY_MODULE}}


##
# Coverage report
##

[testenv:coverage_report]

description = generate coverage report

basepython = python

skip_install = True

deps =
    coverage==4.5.4

commands =
    coverage combine
    coverage report
    coverage html


##
# Codecov
##

[testenv:codecov]

description = upload coverage to Codecov

basepython = python

skip_install = True

deps =
    coverage==4.5.4
    codecov==2.0.15

commands =
    coverage combine
    coverage xml -o "{env:COVERAGE_XML}"
    codecov --file="{env:COVERAGE_XML}" --env \
        GITHUB_REF GITHUB_COMMIT GITHUB_USER GITHUB_WORKFLOW \
        TRAVIS_BRANCH TRAVIS_BUILD_WEB_URL TRAVIS_COMMIT TRAVIS_COMMIT_MESSAGE \
        APPVEYOR_REPO_BRANCH APPVEYOR_REPO_COMMIT \
        APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED


##
# Packaging
##

[testenv:packaging]

description = check for potential packaging problems

basepython = python

deps =
   check-manifest==0.40
   readme_renderer==24.0

commands =
   check-manifest
   python setup.py check --metadata --restructuredtext --strict
